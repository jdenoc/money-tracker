language: generic

git:
  depth: 1

# trusty instance & sudo are needed so we can utilise docker
dist: trusty
sudo: required

addons:
  apt:
    update: true
  hosts:
    - money-tracker.docker

services:
  - docker

env: DOCKER_HOST_IP=127.0.0.1 DUSK_SCREENSHOT_DIRECTORY=tests/Browser/screenshots/

before_install:
  - docker pull composer/composer:php5-alpine
  - docker pull node:6
  - docker-compose -f docker/docker-compose.yml pull
  - docker-compose -f docker/docker-compose.yml build

# $GH_TOKEN should be set in travis-ci settings and generated in GitHub user settings
install:
  # install composer packages
  - if [ -n "$GH_TOKEN" ]; then docker/cmd/composer.sh config github-oauth.github.com ${GH_TOKEN}; fi;
  - docker/cmd/composer.sh install --no-interaction
  # install yarn packages
  - docker/cmd/yarn.sh install --non-interactive
  # start docker containers
  - docker-compose -f docker/docker-compose.yml up -d
  - docker container ls
  - docker volume ls
  # install travis-ci/discord integration script(s)
  - wget https://raw.githubusercontent.com/jdenoc/travis-ci-discord-webhook/1.2.0/send.sh
  - chmod +x send.sh
  - wget https://raw.githubusercontent.com/jdenoc/travis-ci-discord-webhook/1.2.0/image-send.sh
  - chmod +x image-send.sh
  # make sure user `www-data` has ownership of everything
  - docker container exec -t app.money-tracker chown -R www-data:www-data .

cache:
  yarn: true
  directories:
    - vendor              # composer packages
    - node_modules        # yarn/npm packages
    - public/vue/css      # webpack generated css
    - public/vue/js       # webpack generated javascript
    - public/vue/webfonts # webpack generated web-fonts

before_script:
  - docker container exec -t mysql.money-tracker iterate-mysql-health-check
  - docker container exec -t app.money-tracker artisan key:generate
  - docker container exec -t app.money-tracker artisan app:version `git describe`
  - docker container exec -t app.money-tracker artisan config:cache
  - docker container exec -t app.money-tracker env
  # setup log files, so that
  - docker container exec -t --user www-data app.money-tracker touch storage/logs/laravel.debug.log
  - docker container exec -t --user www-data app.money-tracker touch storage/logs/laravel.info.log
  - docker container exec -t --user www-data app.money-tracker touch storage/logs/laravel.notice.log
  - docker container exec -t --user www-data app.money-tracker touch storage/logs/laravel.warning.log
  - docker container exec -t --user www-data app.money-tracker touch storage/logs/laravel.error.log
  - docker container exec -t --user www-data app.money-tracker touch storage/logs/laravel.critical.log
  - docker container exec -t --user www-data app.money-tracker touch storage/logs/laravel.alert.log
  - docker container exec -t --user www-data app.money-tracker touch storage/logs/laravel.emergency.log
  # build/compile website
  - docker/cmd/yarn.sh run build-prod

matrix:
  fast_finish: true

jobs:
  include:
    - stage: phpunit
      script: docker container exec -t app.money-tracker vendor/bin/phpunit --testsuite api-put
    - script: docker container exec -t app.money-tracker vendor/bin/phpunit --testsuite api-get
    - script: docker container exec -t app.money-tracker vendor/bin/phpunit --testsuite api-post
    - script: docker container exec -t app.money-tracker vendor/bin/phpunit --testsuite api-delete
    - script: docker container exec -t app.money-tracker vendor/bin/phpunit --testsuite console
    - script: docker container exec -t app.money-tracker vendor/bin/phpunit --testsuite web
    - script: docker container exec -t app.money-tracker vendor/bin/phpunit --testsuite unit
    - stage: dusk
      script: docker container exec -t app.money-tracker artisan dusk --group demo --stop-on-failure
    - script: docker container exec -t app.money-tracker artisan dusk --group notifications --stop-on-failure
    - script: docker container exec -t app.money-tracker artisan dusk --group navigation --stop-on-failure
    - script: docker container exec -t app.money-tracker artisan dusk --group entry-modal --stop-on-failure
    - script: docker container exec -t app.money-tracker artisan dusk --group filter-modal --stop-on-failure
    - script: docker container exec -t app.money-tracker artisan dusk --group transfer-modal --stop-on-failure

# $WEBHOOK_URL should be set in travis-ci settings
after_success:
  - ./send.sh success $WEBHOOK_URL

after_failure:
  - ./send.sh failure $WEBHOOK_URL
  - ls -la $DUSK_SCREENSHOT_DIRECTORY
  - ./image-send.sh --retry=3 --delay=7 $DUSK_SCREENSHOT_DIRECTORY $WEBHOOK_URL
  - docker container logs --tail all --timestamps app.money-tracker > /dev/null
  - docker/cmd/laravel-logs.sh

after_script:
  - docker-compose -f docker/docker-compose.yml down -v
  - docker container ls
  - docker volume ls

# make sure ONLY updates to the master & develop branches cause a build
branches:
  only:
    - master
    - develop